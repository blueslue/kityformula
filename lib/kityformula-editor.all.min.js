/*!
 * ====================================================
 * Kity Formula Editor - v1.0.0 - 2014-04-16
 * https://github.com/kitygraph/formula
 * GitHub: https://github.com/kitygraph/formula.git 
 * Copyright (c) 2014 Baidu Kity Group; Licensed MIT
 * ====================================================
 */
!function(){function a(a,b,c){if(d[a]={exports:{},value:null,factory:null},2===arguments.length&&(c=b),"[object Object]"===d.toString.call(c))d[a].value=c;else{if("function"!=typeof c)throw new Error("define函数未定义的行为");d[a].factory=c}}function b(a){var c=d[a],e=null;return c?c.value?c.value:(e=c.factory.call(null,b,c.exports,c),e&&(c.exports=e),c.value=c.exports,c.value):null}function c(a){return b(a)}var d={};a("base/common",[],function(){function a(d,e,f,g){return g=0|g,g>b?f:(g++,c.each(f,function(b,f){d?!b||"object"!=typeof b&&"function"!=typeof b?e[f]=b:(e[f]=e[f]||(c.isArray(b)?[]:{}),e[f]=a(d,e[f],b,g)):e[f]=b}),e)}var b=10,c={extend:function(b,d){var e=!1;if("boolean"==typeof b?(e=b,b=d,d=[].splice.call(arguments,2)):d=[].splice.call(arguments,1),!b)throw new Error("Utils: extend, target can not be empty");return c.each(d,function(c){(c&&"object"==typeof c||"function"==typeof c)&&a(e,b,c)}),b},getRect:function(a){return a.getBoundingClientRect()},isArray:function(a){return a&&"[object Array]"==={}.toString.call(a)},isString:function(a){return"string"==typeof a},proxy:function(a,b){return function(){return a.apply(b,arguments)}},each:function(a,b){if(a)if("length"in a&&"number"==typeof a.length)for(var c=0,d=a.length;d>c&&b.call(null,a[c],c,a)!==!1;c++);else for(var e in a)if(a.hasOwnProperty(e)&&b.call(null,a[e],e,a)===!1)break}};return c}),a("base/event/event",["base/event/kfevent","base/common"],function(a){function b(){return++d}var c={},d=0,e=!0,f=a("base/event/kfevent"),g=a("base/common"),h=function(a){var b=a.type,d=a.target,f=this.__kfe_eid,h=/^(?:before|after)/.test(b),j=c[f][b];return h||(i.trigger(d,"before"+b),e!==!1)?(g.each(j,function(b){return b&&b.call(d,a)===!1?e=!1:void 0}),void(h||i.trigger(d,"after"+b))):(e=!0,!1)},i={addEvent:function(a,d,e){var f=!0,g=null;a.__kfe_eid||(f=!1,a.__kfe_eid=b(),c[a.__kfe_eid]={}),g=c[a.__kfe_eid],g[d]||(f=!1,g[d]=[]),g[d].push(e),f||a.addEventListener(d,h,!1)},trigger:function(a,b,c){c=c||f.createEvent(b,c),a.dispatchEvent(c)}};return i}),a("base/event/kfevent",[],function(){return{createEvent:function(a){var b=document.createEvent("Event");return b.initEvent(a,!0,!0),b}}}),a("base/utils",["base/common","base/event/event","base/event/kfevent"],function(a){var b={},c=a("base/common");return c.extend(b,c,a("base/event/event")),b}),a("control/controller",["kity","control/listener","control/location","control/input","control/selection"],function(a){var b=a("kity"),c=a("control/listener"),d=b.createClass("ControllerComponent",{constructor:function(a){this.kfEditor=a,this.components={},this.initComponents()},initComponents:function(){this.components.listener=new c(this,this.kfEditor)}});return d}),a("control/input",["kity","base/utils","base/common","base/event/event"],function(a){var b=a("kity"),c=a("base/utils"),d={LEFT:37,RIGHT:39,DELETE:8};return b.createClass("InputComponent",{constructor:function(a,b){this.parentComponent=a,this.kfEditor=b,this.inputBox=this.createInputBox(),this.initServices(),this.initEvent()},initServices:function(){this.kfEditor.registerService("control.update.input",this,{updateInput:this.updateInput}),this.kfEditor.registerService("control.insert.string",this,{insertStr:this.insertStr})},createInputBox:function(){var a=this.kfEditor.getContainer(),b=this.kfEditor.getDocument().createElement("input");return b.className="kf-editor-input-box",b.type="text",b.isTrusted=!1,a.appendChild(b),b},setUntrusted:function(){this.inputBox.isTrusted=!1},setTrusted:function(){this.inputBox.isTrusted=!0},updateInput:function(){var a=this.kfEditor.requestService("syntax.serialization");this.setUntrusted(),this.inputBox.value=a.str,this.inputBox.selectionStart=a.startOffset,this.inputBox.selectionEnd=a.endOffset,this.inputBox.focus(),this.setTrusted()},insertStr:function(a){var b=this.kfEditor.requestService("syntax.serialization"),c=b.str;c=c.substring(0,b.startOffset)+" "+a+" "+c.substring(b.endOffset),this.restruct(c),this.updateInput()},initEvent:function(){var a=this;c.addEvent(this.inputBox,"keydown",function(b){switch(b.keyCode){case d.LEFT:b.preventDefault(),a.leftMove();break;case d.RIGHT:b.preventDefault(),a.rightMove();break;case d.DELETE:b.preventDefault(),a.delete()}}),c.addEvent(this.inputBox,"input",function(){a.processingInput()}),c.addEvent(this.inputBox,"blur",function(){a.kfEditor.requestService("ui.toolbar.disable"),a.kfEditor.requestService("ui.toolbar.close"),a.kfEditor.requestService("control.cursor.hide"),a.kfEditor.requestService("render.clear.select")}),c.addEvent(this.inputBox,"focus",function(){a.kfEditor.requestService("ui.toolbar.enable"),this.isTrusted&&a.kfEditor.requestService("control.reselect")}),c.addEvent(this.inputBox,"paste",function(){})},hasRootplaceholder:function(){return this.kfEditor.requestService("syntax.has.root.placeholder")},leftMove:function(){this.hasRootplaceholder()||(this.kfEditor.requestService("syntax.cursor.move.left"),this.update())},rightMove:function(){this.hasRootplaceholder()||(this.kfEditor.requestService("syntax.cursor.move.right"),this.update())},"delete":function(){var a=null;this.hasRootplaceholder()||(a=this.kfEditor.requestService("syntax.delete.group"),a?(this.updateInput(),this.processingInput()):(this.updateInput(),this.kfEditor.requestService("control.reselect")))},processingInput:function(){this.restruct(this.inputBox.value)},restruct:function(a){this.kfEditor.requestService("render.draw",a),this.kfEditor.requestService("control.reselect")},update:function(){this.updateInput(),this.kfEditor.requestService("control.reselect")}})}),a("control/listener",["kity","control/location","control/input","base/utils","control/selection"],function(a){var b=a("kity"),c=a("control/location"),d=a("control/input"),e=a("control/selection");return b.createClass("MoveComponent",{constructor:function(a,b){this.parentComponent=a,this.kfEditor=b,this.components={},this.initComponents()},initComponents:function(){this.components.location=new c(this,this.kfEditor),this.components.selection=new e(this,this.kfEditor),this.components.input=new d(this,this.kfEditor)}})}),a("control/location",["kity"],function(a){function b(a){return a.getBoundingClientRect()}var c=a("kity");return c.createClass("LocationComponent",{constructor:function(a,b){this.parentComponent=a,this.kfEditor=b,this.paper=this.getPaper(),this.cursorShape=this.createCursor(),this.initServices(),this.initEvent()},getPaper:function(){return this.kfEditor.requestService("render.get.paper")},initServices:function(){this.kfEditor.registerService("control.cursor.relocation",this,{relocationCursor:this.updateCursor}),this.kfEditor.registerService("control.cursor.hide",this,{hideCursor:this.hideCursor}),this.kfEditor.registerService("control.reselect",this,{reselect:this.reselect})},createCursor:function(){var a=new c.Rect(1,0,0,0).fill("black");return a.setAttr("style","display: none"),this.paper.addShape(a),a},initEvent:function(){var a=this.kfEditor.request("ui.canvas.container.event"),b=this;a.on("mousedown",function(a){a.preventDefault(),b.updateCursorInfo(a),b.kfEditor.requestService("control.update.input"),b.reselect()})},updateCursorInfo:function(a){var b=null,c=null,d=-1;return this.kfEditor.requestService("syntax.has.root.placeholder")?(this.kfEditor.requestService("syntax.update.record.cursor",{groupId:this.kfEditor.requestService("syntax.get.root.group.info").id,startOffset:0,endOffset:1}),!1):(b=this.kfEditor.requestService("position.get.wrap",a.target),b&&this.kfEditor.requestService("syntax.is.placeholder.node",b.id)?(c=this.kfEditor.requestService("position.get.group.info",b),void this.kfEditor.requestService("syntax.update.record.cursor",c.group.id,c.index,c.index+1)):(c=this.kfEditor.requestService("position.get.group",a.target),null===c&&(c=this.kfEditor.requestService("syntax.get.root.group.info")),d=this.getIndex(a.clientX,c),void this.kfEditor.requestService("syntax.update.record.cursor",c.id,d)))},hideCursor:function(){this.cursorShape.setAttr("style","display: none")},reselect:function(){var a=this.kfEditor.requestService("syntax.get.record.cursor"),b=null;return this.hideCursor(),this.kfEditor.requestService("syntax.is.select.placeholder")?(b=this.kfEditor.requestService("syntax.get.group.content",a.groupId),void this.kfEditor.requestService("render.select.group",b.content[a.startOffset].id)):void(a.startOffset===a.endOffset?(this.updateCursor(),this.kfEditor.requestService("render.tint.current.cursor")):this.kfEditor.requestService("render.select.current.cursor"))},updateCursor:function(){var a=this.kfEditor.requestService("syntax.get.record.cursor");if(a.startOffset!==a.endOffset)return void this.hideCursor();var c=this.kfEditor.requestService("syntax.get.group.content",a.groupId),d=0===a.endOffset,e=d?0:a.endOffset-1,f=c.content[e],g=b(this.paper.container.node),h=0,i=b(f),j=this.cursorShape.getTransform(),k=this.kfEditor.requestService("render.get.canvas.zoom"),l=this.paper.getZoom();this.cursorShape.setHeight(i.height/k/l),h=d?i.left-2:i.left+i.width-2,h-=g.left,j.m.e=h/k/l,j.m.f=(i.top-g.top)/k/l,this.cursorShape.setTransform(j),this.cursorShape.setAttr("style","display: block")},getIndex:function(a,c){for(var d=-1,e=c.content,f=null,g=e.length-1,h=null;g>=0;g--)if(d=g,h=e[g],f=b(h),f.left<a){f.left+f.width/2<a&&(d+=1);break}return d}})}),a("control/selection",["kity","base/utils","base/common","base/event/event"],function(a){var b=a("kity"),c=a("base/utils"),d=10;return b.createClass("SelectionComponent",{constructor:function(a,b){this.parentComponent=a,this.kfEditor=b,this.isDrag=!1,this.isMousedown=!1,this.startPoint={x:-1,y:-1},this.startGroupIsPlaceholder=!1,this.startGroup={},this.initEvent()},initEvent:function(){var a=this.kfEditor.request("ui.canvas.container.event"),b=this;a.on("mousedown",function(a){return a.preventDefault(),b.kfEditor.requestService("syntax.has.root.placeholder")?!1:(b.isMousedown=!0,b.updateStartPoint(a.clientX,a.clientY),void b.updateStartGroup())}),a.on("mouseup",function(a){a.preventDefault(),b.stopUpdateSelection()}),a.on("mousemove",function(a){a.preventDefault(),b.isDrag?b.updateSelection(a.target,a.clientX,a.clientY):b.isMousedown&&d<b.getDistance(a.clientX,a.clientY)&&(b.kfEditor.requestService("control.cursor.hide"),b.startUpdateSelection())}),a.on("dblclick",function(a){b.updateSelectionByTarget(a.target)})},getDistance:function(a,b){var c=Math.abs(a-this.startPoint.x),d=Math.abs(b-this.startPoint.y);return Math.max(c,d)},updateStartPoint:function(a,b){this.startPoint.x=a,this.startPoint.y=b},updateStartGroup:function(){var a=this.kfEditor.requestService("syntax.get.record.cursor");this.startGroupIsPlaceholder=this.kfEditor.requestService("syntax.is.select.placeholder"),this.startGroup={groupInfo:this.kfEditor.requestService("syntax.get.group.content",a.groupId),offset:a.startOffset}},startUpdateSelection:function(){this.isDrag=!0,this.isMousedown=!1,this.clearSelection()},stopUpdateSelection:function(){this.isDrag=!1,this.isMousedown=!1,this.kfEditor.requestService("control.update.input")},clearSelection:function(){this.kfEditor.requestService("render.clear.select")},updateSelection:function(a,b){var c=b>this.startPoint.x,d={},e=null,f=!1,g=this.startGroup,h=null,i=this.getGroupInof(b,a);i.groupInfo.id===g.groupInfo.id?(d={groupId:i.groupInfo.id,startOffset:g.offset,endOffset:i.offset},this.startGroupIsPlaceholder&&(c?d.startOffset===d.endOffset&&(d.endOffset+=1):d.startOffset+=1)):g.groupInfo.groupObj.contains(i.groupInfo.groupObj)?d={groupId:g.groupInfo.id,startOffset:g.offset,endOffset:this.getIndex(g.groupInfo.groupObj,a,b)}:i.groupInfo.groupObj.contains(g.groupInfo.groupObj)?(d={groupId:i.groupInfo.id,startOffset:this.kfEditor.requestService("position.get.index",i.groupInfo.groupObj,g.groupInfo.groupObj),endOffset:i.offset},c||(d.startOffset+=1)):(e=this.getUnifiedGroup(g.groupInfo,i.groupInfo),e.startOffset===e.endOffset?e.endOffset+=1:(h=e.group.content[e.endOffset],f=this.kfEditor.requestService("position.get.area",h,b),f&&(e.endOffset+=1),c||(e.startOffset+=1)),d={groupId:e.group.id,startOffset:e.startOffset,endOffset:e.endOffset}),this.kfEditor.requestService("syntax.update.record.cursor",d.groupId,d.startOffset,d.endOffset),this.kfEditor.requestService("control.reselect")},updateSelectionByTarget:function(a){var b=this.kfEditor.requestService("position.get.parent.group",a),c=null,d={};null!==b&&(this.kfEditor.requestService("syntax.is.root.node",b.id)?d={groupId:b.id,startOffset:0,endOffset:b.content.length}:this.kfEditor.requestService("syntax.is.virtual.node",b.id)?(c=this.kfEditor.requestService("position.get.group.info",b.groupObj),d={groupId:c.group.id,startOffset:c.index,endOffset:c.index+1}):d={groupId:b.id,startOffset:0,endOffset:b.content.length},this.kfEditor.requestService("syntax.update.record.cursor",d),this.kfEditor.requestService("control.reselect"),this.kfEditor.requestService("control.update.input"))},getGroupInof:function(a,b){var c=this.kfEditor.requestService("position.get.group",b);null===c&&(c=this.kfEditor.requestService("syntax.get.root.group.info"));var d=this.kfEditor.requestService("position.get.location.info",a,c);return{groupInfo:c,offset:d}},getIndex:function(a,b,d){var e=this.kfEditor.requestService("position.get.index",a,b),f=this.kfEditor.requestService("syntax.get.group.content",a.id),g=f.content[e],h=c.getRect(g);return h.left+h.width/2<d&&(e+=1),e},getUnifiedGroup:function(a,b){for(var c=null,d=a.groupObj,e=null;(c=this.kfEditor.requestService("position.get.group.info",d))&&(d=c.group.groupObj,!c.group.groupObj.contains(b.groupObj)););return e=c.group.groupObj,{group:c.group,startOffset:c.index,endOffset:this.kfEditor.requestService("position.get.index",e,b.groupObj)}}})}),a("def/group-type",[],function(){return{GROUP:"kf-editor-group",VIRTUAL:"kf-editor-virtual-group"}}),a("editor/editor",["kity","base/utils","base/common","base/event/event"],function(a){function b(a){var b=this.services[a];if(!b)throw new Error("KFEditor: not found service, "+a);return b}var c=a("kity"),d=a("base/utils"),e={controller:{zoom:!0,maxzoom:5,minzoom:.5},formula:{fontsize:50,autoresize:!1}},f={},g=c.createClass("KFEditor",{constructor:function(a,b){this.options=d.extend(!0,{},e,b),this.container=a,this.services={},this.commands={},this.initComponents()},getContainer:function(){return this.container},getDocument:function(){return this.container.ownerDocument},getOptions:function(){return this.options},initComponents:function(){var a=this;d.each(f,function(b){new b(a)})},requestService:function(a){var c=b.call(this,a);return c.service[c.key].apply(c.provider,[].slice.call(arguments,1))},request:function(a){var c=b.call(this,a);return c.service},registerService:function(a,b,c){var e=null;for(e in c)c[e]&&c.hasOwnProperty(e)&&(c[e]=d.proxy(c[e],b));this.services[a]={provider:b,key:e,service:c}},registerCommand:function(a,b,c){this.commands[a]={executor:b,execFn:c}},execCommand:function(a){var b=this.commands[a];if(!b)throw new Error("KFEditor: not found command, "+a);return b.execFn.apply(b.executor,[].slice.call(arguments,1))}});return d.extend(g,{registerComponents:function(a,b){f[a]=b}}),g}),a("jquery",[],function(){return window.jQuery}),a("kf-ext/def",[],function(){return{selectColor:"rgba(42, 106, 189, 0.2)",allSelectColor:"rgba(42, 106, 189, 0.6)"}}),a("kf-ext/expression/placeholder",["kity","kf","kf-ext/operator/placeholder","kf-ext/def"],function(a){var b=a("kity"),c=a("kf"),d=a("kf-ext/operator/placeholder");return b.createClass("PlaceholderExpression",{base:c.CompoundExpression,constructor:function(){this.callBase(),this.setFlag("Placeholder"),this.label=null,this.box.setAttr("data-type",null),this.setOperator(new d)},setLabel:function(a){this.label=a},getLabel:function(){return this.label},setAttr:function(a,b){"label"===a?this.setLabel(b):(a.label&&(this.setLabel(a.label),delete a.label),this.callBase(a,b))},select:function(){this.getOperator().select()},selectAll:function(){this.getOperator().selectAll()},unselect:function(){this.getOperator().unselect()}})}),a("kf-ext/extension",["kf","kity","kf-ext/def","kf-ext/expression/placeholder","kf-ext/operator/placeholder"],function(a){function b(b){c.PlaceholderExpression=a("kf-ext/expression/placeholder"),c.Expression.prototype.select=function(){this.box.fill(d)},c.Expression.prototype.selectAll=function(){this.box.fill(e)},c.Expression.prototype.unselect=function(){this.box.fill("transparent")},b.getKFParser().expand({parse:{placeholder:{name:"placeholder",handler:function(a){return delete a.handler,a.operand=[],a},sign:!1}},reverse:{placeholder:function(){return"\\placeholder "}}})}var c=a("kf"),d=(a("kity"),a("kf-ext/def").selectColor),e=a("kf-ext/def").allSelectColor;return{ext:b}}),a("kf-ext/operator/placeholder",["kity","kf-ext/def","kf"],function(a){function b(a,b){return null!==b?d(a,b):c(a)}function c(a){var b=13,c=17,d=null;return d=new e.Rect(b,c,0,0).stroke("black").fill("transparent").translate(2,6),d.setAttr("stroke-dasharray","1, 2"),a.addOperatorShape(d),d}function d(a,b){var c=new e.Text(b),d=new e.Group,f=10,g=null,h=null;return d.addShape(c),a.addOperatorShape(d),h=c.getRenderBox(),g=new e.Rect(h.width+2*f,h.height+2*f,0,0).stroke("black").fill("transparent"),g.setAttr("stroke-dasharray","1, 2"),c.setAttr({dx:0-h.x,dy:0-h.y}),c.translate(f,f),d.addShape(g),g}var e=a("kity"),f=a("kf-ext/def").selectColor,g=a("kf-ext/def").allSelectColor;return e.createClass("PlaceholderOperator",{base:a("kf").Operator,constructor:function(){this.opShape=null,this.callBase("Placeholder")},applyOperand:function(){this.setBoxSize(17,27),this.opShape=b(this,this.parentExpression.getLabel())},select:function(){this.opShape.fill(f)},selectAll:function(){this.opShape.fill(g)},unselect:function(){this.opShape.fill("transparent")}})}),a("kf",[],function(){return window.kf}),a("kity",[],function(){return window.kity}),a("parse/parser",["kf","kity","parse/vgroup-def","parse/root-p-text","def/group-type","kf-ext/extension","kf-ext/def","kf-ext/expression/placeholder"],function(a){function b(a,b,c){var h=null,i=!c;b.attr=b.attr||{},b.attr.id=a.getGroupId(),i?d(a,b):c.attr["data-root"]&&"placeholder"===b.name&&(b.attr.label=m);for(var j=0,k=b.operand.length;k>j;j++)h=b.operand[j],g(b)?e(a,j,b,h):f(a,j,b,h);return b}function c(){return o+ ++q}function d(a,b){a.isResetId?b.attr["data-root"]="true":b.attr["data-type"]=p.VIRTUAL}function e(a,c,d,e){"brackets"===d.name&&2>c||("function"!==d.name||0!==c)&&(d.attr["data-type"]=p.VIRTUAL,e?"string"==typeof e?(d.operand[c]=i(a),d.operand[c].operand[0]=e):h(e)?(d.operand[c]=i(a),d.operand[c].operand[0]=b(a,e,d.operand[c])):d.operand[c]=b(a,e,d):d.operand[c]=e)}function f(a,c,d,e){d.attr["data-type"]=p.GROUP,d.operand[c]=e&&"string"!=typeof e?b(a,e,d):e}function g(a){return!!l[a.name]}function h(a){return"placeholder"===a.name}function i(a){return{name:n,attr:{"data-type":p.GROUP,id:a.getGroupId()},operand:[]}}var j=a("kf").Parser,k=a("kity"),l=a("parse/vgroup-def"),m=a("parse/root-p-text"),n="combination",o="_kf_editor_",p=a("def/group-type"),q=0,r=k.createClass("Parser",{constructor:function(a){this.kfEditor=a,this.callBase(),this.kfParser=j.use("latex"),this.initKFormulExtension(),this.pid=c(),this.groupRecord=0,this.tree=null,this.isResetId=!0,this.initServices()},parse:function(a,c){var d=null;return this.isResetId=!!c,this.isResetId&&this.resetGroupId(),d=this.kfParser.parse(a),b(this,d.tree),d},serialization:function(a){return this.kfParser.serialization(a)},initServices:function(){this.kfEditor.registerService("parser.parse",this,{parse:this.parse}),this.kfEditor.registerService("parser.latex.serialization",this,{serialization:this.serialization})},getKFParser:function(){return this.kfParser},initKFormulExtension:function(){a("kf-ext/extension").ext(this)},resetGroupId:function(){this.groupRecord=0},getGroupId:function(){return this.pid+"_"+ ++this.groupRecord}});return r}),a("parse/root-p-text",[],function(){return"在此处键入公式"}),a("parse/vgroup-def",[],function(){return{radical:!0,fraction:!0,summation:!0,integration:!0,placeholder:!0,script:!0,superscript:!0,subscript:!0,brackets:!0,"function":!0}}),a("position/position",["kity","base/utils","base/common","base/event/event"],function(a){function b(a,c,d){var e=null;return a.ownerSVGElement?(a=a.parentNode,e=a.tagName.toLowerCase(),a&&"body"!==e&&"svg"!==e?"kf-editor-group"===a.getAttribute("data-type")?a:c&&"kf-editor-virtual-group"===a.getAttribute("data-type")?a:d&&null!==a.getAttribute("data-flag")?a:b(a,c,d):null):null}var c=a("kity"),d=a("base/utils"),e=c.createClass("PositionComponenet",{constructor:function(a){this.kfEditor=a,this.initServices()},initServices:function(){this.kfEditor.registerService("position.get.group",this,{getGroupByTarget:this.getGroupByTarget}),this.kfEditor.registerService("position.get.index",this,{getIndexByTargetInGroup:this.getIndexByTargetInGroup}),this.kfEditor.registerService("position.get.location.info",this,{getLocationInfo:this.getLocationInfo}),this.kfEditor.registerService("position.get.parent.group",this,{getParentGroupByTarget:this.getParentGroupByTarget}),this.kfEditor.registerService("position.get.wrap",this,{getWrap:this.getWrap}),this.kfEditor.registerService("position.get.area",this,{getAreaByCursorInGroup:this.getAreaByCursorInGroup}),this.kfEditor.registerService("position.get.group.info",this,{getGroupInfoByNode:this.getGroupInfoByNode}),this.kfEditor.registerService("position.get.parent.info",this,{getParentInfoByNode:this.getParentInfoByNode})},getGroupByTarget:function(a){var c=b(a,!1,!1);return c?this.kfEditor.requestService("syntax.get.group.content",c.id):null},getIndexByTargetInGroup:function(a,b){var d=this.kfEditor.requestService("syntax.get.group.content",a.id),e=-1;return c.Utils.each(d.content,function(a,c){return e=c,a.contains(b)?!1:void 0}),e},getAreaByCursorInGroup:function(a,b){var c=d.getRect(a);return c.left+c.width/2<b},getLocationInfo:function(a,b){for(var c=-1,e=b.content,f=null,g=e.length-1,h=null;g>=0;g--)if(c=g,h=e[g],f=d.getRect(h),f.left<a){f.left+f.width/2<a&&(c+=1);break}return c},getParentGroupByTarget:function(a){var c=b(a,!0,!1);return c?this.kfEditor.requestService("syntax.get.group.content",c.id):null},getWrap:function(a){return b(a,!0,!0)},getGroupInfoByNode:function(a){var c={},d=b(a,!1,!1),e=null;if(!d)return null;e=this.kfEditor.requestService("syntax.get.group.content",d.id);for(var f=0,g=e.content.length;g>f&&(c.index=f,!e.content[f].contains(a));f++);return c.group=e,c},getParentInfoByNode:function(a){var c=b(a,!0,!1);return c=this.kfEditor.requestService("syntax.get.group.content",c.id),{group:c,index:c.content.indexOf(a)}}});return e}),a("render/render",["kity","kf"],function(a){var b=a("kity"),c=a("kf").Assembly,d={autoresize:!1,fontsize:30,padding:[20,50]},e=b.createClass("RenderComponent",{constructor:function(a){this.kfEditor=a,this.assembly=null,this.formula=null,this.canvasZoom=1,this.record={select:{},cursor:{}},this.initCanvas(),this.initServices(),this.initCommands()},initCanvas:function(){var a=this.kfEditor.requestService("ui.get.canvas.container");this.assembly=c.use(a,d),this.formula=this.assembly.formula},initServices:function(){this.kfEditor.registerService("render.relocation",this,{relocation:this.relocation}),this.kfEditor.registerService("render.select.group.content",this,{selectGroupContent:this.selectGroupContent}),this.kfEditor.registerService("render.select.group",this,{selectGroup:this.selectGroup}),this.kfEditor.registerService("render.select.group.all",this,{selectAllGroup:this.selectAllGroup}),this.kfEditor.registerService("render.tint.current.cursor",this,{tintCurrentGroup:this.tintCurrentGroup}),this.kfEditor.registerService("render.select.current.cursor",this,{selectCurrentCursor:this.selectCurrentCursor}),this.kfEditor.registerService("render.reselect",this,{reselect:this.reselect}),this.kfEditor.registerService("render.clear.select",this,{clearSelect:this.clearSelect}),this.kfEditor.registerService("render.set.canvas.zoom",this,{setCanvasZoom:this.setCanvasZoom}),this.kfEditor.registerService("render.get.canvas.zoom",this,{getCanvasZoom:this.getCanvasZoom}),this.kfEditor.registerService("render.get.paper.offset",this,{getPaperOffset:this.getPaperOffset}),this.kfEditor.registerService("render.draw",this,{render:this.render}),this.kfEditor.registerService("render.insert.string",this,{insertString:this.insertString}),this.kfEditor.registerService("render.insert.group",this,{insertGroup:this.insertGroup}),this.kfEditor.registerService("render.get.paper",this,{getPaper:this.getPaper})},initCommands:function(){this.kfEditor.registerCommand("render",this,this.render),this.kfEditor.registerCommand("getPaper",this,this.getPaper)},relocation:function(){var a=this.formula.container.getRenderBox(),b=this.formula.getViewPort();b.center.x=a.width/2,b.center.y=a.height/2,this.formula.setViewPort(b)},selectGroup:function(a){var b=this.kfEditor.requestService("syntax.get.group.object",a);this.clearSelect(),b.node.getAttribute("data-root")||(this.record.select.lastSelect=b,b.select())},selectGroupContent:function(a){null!==a.groupObj.getAttribute("data-placeholder")&&(a={id:a.content[0].id});var b=this.kfEditor.requestService("syntax.get.group.object",a.id);this.clearSelect(),this.record.select.lastSelect=b,b.node.getAttribute("data-root")||b.select()},selectAllGroup:function(a){null!==a.groupObj.getAttribute("data-placeholder")&&(a={id:a.content[0].id});var b=this.kfEditor.requestService("syntax.get.group.object",a.id);this.clearSelect(),this.record.select.lastSelect=b,b.selectAll()},selectCurrentCursor:function(){var a=this.kfEditor.requestService("syntax.get.record.cursor"),b=this.kfEditor.requestService("syntax.get.group.object",a.groupId),c=null,d=-1,e=0,f=b.getRenderBox().height,g=Math.min(a.startOffset,a.endOffset),h=Math.max(a.startOffset,a.endOffset);this.clearSelect(),this.record.select.lastSelect=b;for(var i=g,j=h;j>i;i++)c=b.getOperand(i).getRenderBox(),-1==d&&(d=c.x),e+=c.width;b.setBoxSize(e,f),b.selectAll(),b.getBox().translate(d,0)},tintCurrentGroup:function(){var a=this.kfEditor.requestService("syntax.get.record.cursor").groupId,b=this.kfEditor.requestService("syntax.get.group.object",a),c=this.kfEditor.requestService("syntax.is.placeholder.node",a);this.clearSelect(),b.node.getAttribute("data-root")||(c&&(b=this.kfEditor.requestService("syntax.get.group.object",b.operands[0].node.id)),this.record.select.lastSelect=b,b.select())},reselect:function(){var a=this.kfEditor.requestService("syntax.get.record.cursor"),b=null;b=this.kfEditor.requestService("syntax.get.group.object",a.groupId),this.clearSelect(),this.record.select.lastSelect=b,b.node.getAttribute("data-root")||b.select()},clearSelect:function(){var a=null,b=null,c=this.record.select.lastSelect;c&&(c.unselect(),a=c.getRenderBox(),c.setBoxSize(a.width,a.height),b=c.getBox().getTransform(),b&&(b.m.e=0,b.m.f=0),c.getBox().setTransform(b))},getPaper:function(){return this.formula},render:function(a){var b=this.kfEditor.requestService("parser.parse",a,!0),c=this.assembly.regenerateBy(b);this.kfEditor.requestService("syntax.update.objtree",c),this.relocation()},setCanvasZoom:function(a){var b=this.formula.getViewPort();this.canvasZoom=a,b.zoom=a,this.formula.setViewPort(b)},getCanvasZoom:function(){return this.canvasZoom}});return e}),a("syntax/delete",["kity"],function(a){var b=a("kity");return b.createClass("DeleteComponent",{constructor:function(a,b){this.parentComponent=a,this.kfEditor=b},deleteGroup:function(){var a=this.parentComponent.getCursorRecord(),b=this.parentComponent.getObjectTree(),c=b.mapping[a.groupId].strGroup;return a.startOffset!==a.endOffset?this.parentComponent.isSelectPlaceholder()?this.parentComponent.isRootTree(c)?!1:(a=this.selectParentContainer(a.groupId),this.parentComponent.updateCursor(a),!1):this.deleteSelection(c,a):0===a.startOffset?this.parentComponent.isRootTree(c)?!1:(a=this.selectParentContainer(a.groupId),this.parentComponent.updateCursor(a),!1):c.operand.length>1?(a=this.deletePrevGroup(c,a),this.parentComponent.updateCursor(a),a.startOffset===a.endOffset?!0:!1):(a.startOffset=0,a.endOffset=1,c.operand[0].attr&&this.parentComponent.isGroupNode(c.operand[0].attr.id)?(this.parentComponent.updateCursor(a),!1):(c.operand[0]={name:"placeholder",operand:[]},this.parentComponent.updateCursor(a),!0))},deletePrevGroup:function(a,b){var c=b.startOffset-1,d=a.operand[c];return this.parentComponent.isLeafTree(d)?(a.operand.splice(c,1),b.startOffset-=1,b.endOffset-=1):b.startOffset-=1,b},deleteSelection:function(a,b){return 0===b.startOffset&&b.endOffset===a.operand.length?(a.operand.length=1,a.operand[0]={name:"placeholder",operand:[]},b.endOffset=1):(a.operand.splice(b.startOffset,b.endOffset-b.startOffset),b.endOffset=b.startOffset),this.parentComponent.updateCursor(b),!0},selectParentContainer:function(a){var b=this.parentComponent.getGroupObject(a).node,c=this.kfEditor.requestService("position.get.group",b),d=this.kfEditor.requestService("position.get.index",c.groupObj,b);return{groupId:c.id,startOffset:d,endOffset:d+1}}})}),a("syntax/move",["kity"],function(a){function b(a){var b=null,c=this.parentComponent,f=null;return f=c.getGroupContent(a.groupId),c.isSelectPlaceholder()?e(this,f.content[a.startOffset],p.LEFT):(a.startOffset===a.endOffset?a.startOffset>0?(b=f.content[a.startOffset-1],l(b)?a=d(this,b,p.LEFT):(a.startOffset-=1,m(b)||(a.endOffset=a.startOffset))):a=e(this,f.groupObj,p.LEFT):(a.startOffset=Math.min(a.startOffset,a.endOffset),a.endOffset=a.startOffset),a)}function c(a){var b=null,c=this.parentComponent,f=null;return f=c.getGroupContent(a.groupId),c.isSelectPlaceholder()?e(this,f.content[a.startOffset],p.RIGHT):(a.startOffset===a.endOffset?a.startOffset<f.content.length?(b=f.content[a.startOffset],l(b)?a=d(this,b,p.RIGHT):(a.startOffset+=1,m(b)||(a.endOffset=a.startOffset))):a=e(this,f.groupObj,p.RIGHT):(a.endOffset=Math.max(a.startOffset,a.endOffset),a.startOffset=a.endOffset),a)}function d(a,b,c){switch(c){case p.LEFT:return f(a,b);case p.RIGHT:return h(a,b)}throw new Error("undefined move direction!")}function e(a,b,c){switch(c){case p.LEFT:return g(a,b);case p.RIGHT:return i(a,b)}throw new Error("undefined move direction!")}function f(a,b){var c=a.parentComponent,d=null,e=null;if(m(b)||n(b))return g(a,b);if(l(b)){if(d=c.getGroupContent(b.id),e=d.content[d.content.length-1],n(e))return g(a,e);if(k(b))return m(e)?{groupId:b.id,startOffset:d.content.length-1,endOffset:d.content.length}:k(e)&&1===d.content.length?f(a,e):{groupId:b.id,startOffset:d.content.length,endOffset:d.content.length};for(;!k(e)&&!n(e)&&!m(e);)d=c.getGroupContent(e.id),e=d.content[d.content.length-1];return n(e)?g(a,e):m(e)?{groupId:e.id,startOffset:d.content.length,endOffset:d.content.length}:f(a,e)}return null}function g(a,b){var c=a.kfEditor,d=(a.parentComponent,null);if(j(b))return null;for(d=c.requestService("position.get.parent.info",b);0===d.index;){if(j(d.group.groupObj))return{groupId:d.group.id,startOffset:0,endOffset:0};if(k(d.group.groupObj)&&d.group.content.length>1)return{groupId:d.group.id,startOffset:0,endOffset:0};d=c.requestService("position.get.parent.info",d.group.groupObj)}return k(d.group.groupObj)?{groupId:d.group.id,startOffset:d.index,endOffset:d.index}:(b=d.group.content[d.index-1],l(b)?k(b)?f(a,b):f(a,b):n(b)?g(a,b):{groupId:d.group.id,startOffset:d.index,endOffset:d.index})}function h(a,b){var c=a.parentComponent,d=null,e=null;if(l(b)){if(d=c.getGroupContent(b.id),e=d.content[0],k(b))return k(e)?h(a,e):m(e)?{groupId:b.id,startOffset:0,endOffset:1}:{groupId:b.id,startOffset:0,endOffset:0};for(;!k(e)&&!m(e)&&!n(e);)d=c.getGroupContent(e.id),e=d.content[0];return m(e)?{groupId:e.id,startOffset:0,endOffset:0}:n(e)?i(a,e):h(a,e)}return null}function i(a,b){var c=a.kfEditor,d=a.parentComponent,e=null,f=null;if(j(b))return null;for(e=c.requestService("position.get.parent.info",b);e.index===e.group.content.length-1;){if(j(e.group.groupObj))return{groupId:e.group.id,startOffset:e.group.content.length,endOffset:e.group.content.length};
if(k(e.group.groupObj)&&e.group.content.length>1)return{groupId:e.group.id,startOffset:e.group.content.length,endOffset:e.group.content.length};e=c.requestService("position.get.parent.info",e.group.groupObj)}return b=e.group.content[e.index+1],n(b)?i(a,b):k(b)?(f=d.getGroupContent(b.id),d.isPlaceholder(f.content[0].id)?{groupId:b.id,startOffset:0,endOffset:1}:{groupId:b.id,startOffset:0,endOffset:0}):{groupId:e.group.id,startOffset:e.index+1,endOffset:e.index+1}}function j(a){return!!a.getAttribute("data-root")}function k(a){return"kf-editor-group"===a.getAttribute("data-type")}function l(a){var b=a.getAttribute("data-type");return"kf-editor-group"===b||"kf-editor-virtual-group"===b}function m(a){return"Placeholder"===a.getAttribute("data-flag")}function n(a){return"Empty"===a.getAttribute("data-flag")}var o=a("kity"),p={LEFT:"left",RIGHT:"right"};return o.createClass("MoveComponent",{constructor:function(a,b){this.parentComponent=a,this.kfEditor=b},leftMove:function(){var a=this.parentComponent.getCursorRecord();a=b.call(this,a),a&&this.parentComponent.updateCursor(a)},rightMove:function(){var a=this.parentComponent.getCursorRecord();a=c.call(this,a),a&&this.parentComponent.updateCursor(a)}})}),a("syntax/syntax",["kity","syntax/move","syntax/delete","def/group-type"],function(a){var b=a("kity"),c=a("syntax/move"),d=a("syntax/delete"),e="",f=a("def/group-type"),g=b.createClass("SyntaxComponenet",{constructor:function(a){this.kfEditor=a,this.record={cursor:{group:null,startOffset:-1,endOffset:-1}},this.components={},this.objTree=null,this.initComponents(),this.initServices()},initComponents:function(){this.components.move=new c(this,this.kfEditor),this.components["delete"]=new d(this,this.kfEditor)},initServices:function(){this.kfEditor.registerService("syntax.update.objtree",this,{updateObjTree:this.updateObjTree}),this.kfEditor.registerService("syntax.get.objtree",this,{getObjectTree:this.getObjectTree}),this.kfEditor.registerService("syntax.get.group.object",this,{getGroupObject:this.getGroupObject}),this.kfEditor.registerService("syntax.is.root.node",this,{isRootNode:this.isRootNode}),this.kfEditor.registerService("syntax.is.group.node",this,{isGroupNode:this.isGroupNode}),this.kfEditor.registerService("syntax.is.virtual.node",this,{isVirtualNode:this.isVirtualNode}),this.kfEditor.registerService("syntax.is.placeholder.node",this,{isPlaceholder:this.isPlaceholder}),this.kfEditor.registerService("syntax.is.select.placeholder",this,{isSelectPlaceholder:this.isSelectPlaceholder}),this.kfEditor.registerService("syntax.has.root.placeholder",this,{hasRootplaceholder:this.hasRootplaceholder}),this.kfEditor.registerService("syntax.valid.brackets",this,{isBrackets:this.isBrackets}),this.kfEditor.registerService("syntax.get.group.content",this,{getGroupContent:this.getGroupContent}),this.kfEditor.registerService("syntax.get.root.group.info",this,{getRootGroupInfo:this.getRootGroupInfo}),this.kfEditor.registerService("syntax.update.record.cursor",this,{updateCursor:this.updateCursor}),this.kfEditor.registerService("syntax.update.selection",this,{updateSelection:this.updateSelection}),this.kfEditor.registerService("syntax.get.record.cursor",this,{getCursorRecord:this.getCursorRecord}),this.kfEditor.registerService("syntax.serialization",this,{serialization:this.serialization}),this.kfEditor.registerService("syntax.cursor.move.left",this,{leftMove:this.leftMove}),this.kfEditor.registerService("syntax.cursor.move.right",this,{rightMove:this.rightMove}),this.kfEditor.registerService("syntax.delete.group",this,{deleteGroup:this.deleteGroup})},updateObjTree:function(a){var b=a.select;b&&b.groupId&&this.updateCursor(b.groupId,b.startOffset,b.endOffset),this.objTree=a},isRootNode:function(a){return this.objTree.mapping.root.strGroup.attr.id===a},isGroupNode:function(a){var b=this.objTree.mapping[a].strGroup.attr["data-type"];return b===f.GROUP||b===f.VIRTUAL},isVirtualNode:function(a){return this.objTree.mapping[a].strGroup.attr["data-type"]===f.VIRTUAL},isPlaceholder:function(a){var b=this.objTree.mapping[a];return b?(b=b.objGroup.node,"Placeholder"===b.getAttribute("data-flag")):!1},isBrackets:function(a){return!!this.objTree.mapping[a].objGroup.node.getAttribute("data-brackets")},hasRootplaceholder:function(){return"placeholder"===this.objTree.mapping.root.strGroup.operand[0].name},isSelectPlaceholder:function(){var a=this.record.cursor,b=null;return a.endOffset-a.startOffset!==1?!1:(b=this.getGroupContent(a.groupId),this.isPlaceholder(b.content[a.startOffset].id)?!0:!1)},isLeafTree:function(a){return"string"==typeof a},isRootTree:function(a){return a.attr&&a.attr["data-root"]},getObjectTree:function(){return this.objTree},getGroupObject:function(a){return this.objTree.mapping[a].objGroup||null},getCursorRecord:function(){return b.Utils.extend({},this.record.cursor)||null},getGroupContent:function(a){var c=this.objTree.mapping[a],d=[],e=c.objGroup.operands,f=e.length-1,g="rtl"!==c.strGroup.traversal;return b.Utils.each(e,function(a,b){g?d.push(a.node):d[f-b]=a.node}),{id:a,traversal:c.strGroup.traversal||"ltr",groupObj:c.objGroup.node,content:d}},getRootGroupInfo:function(){var a=this.objTree.mapping.root.strGroup.attr.id;return this.getGroupContent(a)},updateSelection:function(a){var b=this.objTree.mapping[a.id],c=b.strGroup,d=null,f=null,g=null,h=-1,i=-1;if(d=a,f=b,"combination"===c.name)this.record.cursor={groupId:d.id,startOffset:0,endOffset:c.operand.length},c.operand.unshift(e),c.operand.push(e);else{for(;"combination"!==f.strGroup.name||1===d.content;)a=d,b=f,d=this.kfEditor.requestService("position.get.parent.group",b.objGroup.node),f=this.objTree.mapping[d.id];var j=[].indexOf.call(d.content,a.groupObj);this.record.cursor={groupId:d.id,startOffset:j,endOffset:j+1},f.strGroup.operand.splice(j+1,0,e),f.strGroup.operand.splice(j,0,e)}return g=this.kfEditor.requestService("parser.latex.serialization",this.objTree.parsedTree),h=g.indexOf(e),g=g.replace(e,""),i=g.indexOf(e),f.strGroup.operand.splice(this.record.cursor.startOffset,1),f.strGroup.operand.splice(this.record.cursor.endOffset,1),{str:g,startOffset:h,endOffset:i}},serialization:function(){var a=this.record.cursor,b=this.objTree.mapping[a.groupId],c=b.strGroup,d=null,f=-1,g=-1;return f=Math.min(a.endOffset,a.startOffset),g=Math.max(a.endOffset,a.startOffset),c.operand.splice(g,0,e),c.operand.splice(f,0,e),g+=1,d=this.kfEditor.requestService("parser.latex.serialization",this.objTree.parsedTree),c.operand.splice(g,1),c.operand.splice(f,1),f=d.indexOf(e),a.startOffset===a.endOffset&&(d=d.replace(e,"")),g=d.lastIndexOf(e),{str:d,startOffset:f,endOffset:g}},updateCursor:function(a,b,c){var d=null;1===arguments.length&&(c=a.endOffset,b=a.startOffset,a=a.groupId),void 0===c&&(c=b),b>c&&(d=c,c=b,b=d),this.record.cursor={groupId:a,startOffset:b,endOffset:c}},leftMove:function(){this.components.move.leftMove()},rightMove:function(){this.components.move.rightMove()},deleteGroup:function(){return this.components.delete.deleteGroup()},insertSubtree:function(a){var b=this.record.cursor,c=0,d=0,e=null,f=0;this.isPlaceholder(b.groupId)?this.replaceTree(a):(c=Math.min(b.startOffset,b.endOffset),d=Math.max(b.startOffset,b.endOffset),f=d-c,e=this.objTree.mapping[b.groupId].strGroup,e.operand.splice(c,f,a),b.startOffset+=1,b.endOffset=b.startOffset)},replaceTree:function(a){var b=this.record.cursor,c=this.objTree.mapping[b.groupId].objGroup.node,d=this.kfEditor.requestService("position.get.parent.info",c),e=this.objTree.mapping[d.group.id].strGroup;e.operand[d.index]=a,b.groupId=d.group.id,b.startOffset=d.index+1,b.endOffset=d.index+1}});return g}),a("ui/control/zoom",["base/utils","base/common","base/event/event","kity"],function(a){var b=a("base/utils"),c=a("kity"),d={min:.5,max:5},e=c.createClass("ScrollZoomController",{constructor:function(a,c,e,f){this.kfEditor=c,this.target=e,this.zoom=1,this.step=.05,this.options=b.extend({},d,f),this.initEvent()},initEvent:function(){var a=this.kfEditor,c=this,d=this.options.min,e=this.options.max,f=this.step;b.addEvent(this.target,"mousewheel",function(b){b.preventDefault(),b.wheelDelta<0?c.zoom-=c.zoom*f:c.zoom+=c.zoom*f,c.zoom=Math.max(c.zoom,d),c.zoom=Math.min(c.zoom,e),a.requestService("render.set.canvas.zoom",c.zoom)})}});return e}),a("ui/toolbar-ele-list",["ui/ui-impl/def/ele-type","ui/ui-impl/def/box-type","kity"],function(a){function b(a){var b=[],c=a.path,d=a.values;return e.Utils.each(d,function(a){b.push({item:{show:'<img src="'+c+a.toLowerCase()+'.png">',val:"\\"+a}})}),b}var c=a("ui/ui-impl/def/ele-type"),d=a("ui/ui-impl/def/box-type"),e=a("kity"),f=[{type:c.DRAPDOWN_BOX,options:{button:{label:"预设",icon:"assets/images/toolbar/button/pi.png"},box:{width:367,group:[{title:"预设公式",items:[{title:"预设公式",content:[{label:"二次公式",item:{show:'<img src="assets/images/toolbar/ys/1.png">',val:"x=\\frac {-b\\pm\\sqrt {b^2-4ac}}{2a}"}},{label:"二项式定理",item:{show:'<img src="assets/images/toolbar/ys/2.png">',val:"{\\left(x+a\\right)}^2=\\sum^n_{k=0}{\\left(^n_k\\right)x^ka^{n-k}}"}},{label:"勾股定理",item:{show:'<img src="assets/images/toolbar/ys/3.png">',val:"a^2+b^2=c^2"}}]}]}]}}},{type:c.DELIMITER},{type:c.AREA,options:{button:{icon:"assets/images/toolbar/char/button.png"},box:{width:527,type:d.OVERLAP,group:[{title:"基础数学",items:[{title:"基础数学",content:[{item:{show:'<img src="assets/images/toolbar/char/math/pm.png">',val:"\\pm"}},{item:{show:'<img src="assets/images/toolbar/char/math/infty.png">',val:"\\infty"}},{item:{show:'<img src="assets/images/toolbar/char/math/eq.png">',val:"="}},{item:{show:'<img src="assets/images/toolbar/char/math/sim.png">',val:"\\sim"}},{item:{show:'<img src="assets/images/toolbar/char/math/times.png">',val:"\\times"}},{item:{show:'<img src="assets/images/toolbar/char/math/div.png">',val:"\\div"}},{item:{show:'<img src="assets/images/toolbar/char/math/tanhao.png">',val:"!"}},{item:{show:'<img src="assets/images/toolbar/char/math/lt.png">',val:"<"}},{item:{show:'<img src="assets/images/toolbar/char/math/ll.png">',val:"\\ll"}},{item:{show:'<img src="assets/images/toolbar/char/math/gt.png">',val:">"}},{item:{show:'<img src="assets/images/toolbar/char/math/gg.png">',val:"\\gg"}},{item:{show:'<img src="assets/images/toolbar/char/math/leq.png">',val:"\\leq"}},{item:{show:'<img src="assets/images/toolbar/char/math/geq.png">',val:"\\geq"}},{item:{show:'<img src="assets/images/toolbar/char/math/mp.png">',val:"\\mp"}},{item:{show:'<img src="assets/images/toolbar/char/math/simeq.png">',val:"\\simeq"}},{item:{show:'<img src="assets/images/toolbar/char/math/equiv.png">',val:"\\equiv"}}]}]},{title:"希腊字母",items:[]},{title:"求反关系运算符",items:[]}]}}},{type:c.DELIMITER},{type:c.DRAPDOWN_BOX,options:{button:{label:"分数",icon:"assets/images/toolbar/button/frac.png"},box:{width:332,group:[{title:"分数",items:[{title:"分数",content:[{item:{show:'<img src="assets/images/toolbar/frac/1.png">',val:"\\frac \\placeholder\\placeholder"}},{item:{show:'<img src="assets/images/toolbar/frac/2.png">',val:"{\\placeholder/\\placeholder}"}}]},{title:"常用分数",content:[{item:{show:'<img src="assets/images/toolbar/frac/c1.png">',val:"\\frac {dy}{dx}"}},{item:{show:'<img src="assets/images/toolbar/frac/c2.png">',val:"\\frac {\\Delta y}{\\Delta x}"}},{item:{show:'<img src="assets/images/toolbar/frac/c4.png">',val:"\\frac {\\delta y}{\\delta x}"}},{item:{show:'<img src="assets/images/toolbar/frac/c5.png">',val:"\\frac \\pi 2"}}]}]}]}}},{type:c.DRAPDOWN_BOX,options:{button:{label:"上下标",icon:"assets/images/toolbar/button/script.png"},box:{width:332,group:[{title:"上标和下标",items:[{title:"上标和下标",content:[{item:{show:'<img src="assets/images/toolbar/script/1.png">',val:"\\placeholder^\\placeholder"}},{item:{show:'<img src="assets/images/toolbar/script/2.png">',val:"\\placeholder_\\placeholder"}},{item:{show:'<img src="assets/images/toolbar/script/3.png">',val:"\\placeholder^\\placeholder_\\placeholder"}},{item:{show:'<img src="assets/images/toolbar/script/4.png">',val:"{^\\placeholder_\\placeholder\\placeholder}"}}]},{title:"常用的上标和下标",content:[{item:{show:'<img src="assets/images/toolbar/script/c1.png">',val:"e^{-i\\omega t}"}},{item:{show:'<img src="assets/images/toolbar/script/c2.png">',val:"x^2"}},{item:{show:'<img src="assets/images/toolbar/script/c3.png">',val:"^n_1Y"}}]}]}]}}},{type:c.DRAPDOWN_BOX,options:{button:{label:"根式",icon:"assets/images/toolbar/button/sqrt.png"},box:{width:332,group:[{title:"根式",items:[{title:"根式",content:[{item:{show:'<img src="assets/images/toolbar/sqrt/1.png">',val:"\\sqrt \\placeholder"}},{item:{show:'<img src="assets/images/toolbar/sqrt/2.png">',val:"\\sqrt [\\placeholder] \\placeholder"}},{item:{show:'<img src="assets/images/toolbar/sqrt/3.png">',val:"\\sqrt [2] \\placeholder"}},{item:{show:'<img src="assets/images/toolbar/sqrt/4.png">',val:"\\sqrt [3] \\placeholder"}}]},{title:"常用根式",content:[{item:{show:'<img src="assets/images/toolbar/sqrt/c1.png">',val:"\\frac {-b\\pm\\sqrt{b^2-4ac}}{2a}"}},{item:{show:'<img src="assets/images/toolbar/sqrt/c2.png">',val:"\\sqrt {a^2+b^2}"}}]}]}]}}},{type:c.DRAPDOWN_BOX,options:{button:{label:"积分",icon:"assets/images/toolbar/button/int.png"},box:{width:332,group:[{title:"积分",items:[{title:"积分",content:[{item:{show:'<img src="assets/images/toolbar/int/1.png">',val:"\\int \\placeholder"}},{item:{show:'<img src="assets/images/toolbar/int/2.png">',val:"\\int^\\placeholder_\\placeholder\\placeholder"}},{item:{show:'<img src="assets/images/toolbar/int/3.png">',val:"\\iint\\placeholder"}},{item:{show:'<img src="assets/images/toolbar/int/4.png">',val:"\\iint^\\placeholder_\\placeholder\\placeholder"}},{item:{show:'<img src="assets/images/toolbar/int/5.png">',val:"\\iiint\\placeholder"}},{item:{show:'<img src="assets/images/toolbar/int/6.png">',val:"\\iiint^\\placeholder_\\placeholder\\placeholder"}}]}]}]}}},{type:c.DRAPDOWN_BOX,options:{button:{label:"大型运算符",icon:"assets/images/toolbar/button/sum.png"},box:{width:332,group:[{title:"求和",items:[{title:"求和",content:[{item:{show:'<img src="assets/images/toolbar/large/1.png">',val:"\\sum\\placeholder"}},{item:{show:'<img src="assets/images/toolbar/large/2.png">',val:"\\sum^\\placeholder_\\placeholder\\placeholder"}},{item:{show:'<img src="assets/images/toolbar/large/3.png">',val:"\\sum_\\placeholder\\placeholder"}}]}]}]}}},{type:c.DRAPDOWN_BOX,options:{button:{label:"括号",icon:"assets/images/toolbar/button/brackets.png"},box:{width:332,group:[{title:"方括号",items:[{title:"方括号",content:[{item:{show:'<img src="assets/images/toolbar/brackets/1.png">',val:"\\left(\\placeholder\\right)"}},{item:{show:'<img src="assets/images/toolbar/brackets/2.png">',val:"\\left[\\placeholder\\right]"}},{item:{show:'<img src="assets/images/toolbar/brackets/3.png">',val:"\\left\\{\\placeholder\\right\\}"}},{item:{show:'<img src="assets/images/toolbar/brackets/4.png">',val:"\\left|\\placeholder\\right|"}}]}]}]}}},{type:c.DRAPDOWN_BOX,options:{button:{label:"函数",icon:"assets/images/toolbar/button/sin.png"},box:{width:265,group:[{title:"函数",items:[{title:"三角函数",content:[{item:{show:'<img src="assets/images/toolbar/func/1.png">',val:"\\sin\\placeholder"}},{item:{show:'<img src="assets/images/toolbar/func/2.png">',val:"\\cos\\placeholder"}},{item:{show:'<img src="assets/images/toolbar/func/3.png">',val:"\\tan\\placeholder"}},{item:{show:'<img src="assets/images/toolbar/func/4.png">',val:"\\csc\\placeholder"}},{item:{show:'<img src="assets/images/toolbar/func/5.png">',val:"\\sec\\placeholder"}},{item:{show:'<img src="assets/images/toolbar/func/6.png">',val:"\\cot\\placeholder"}}]},{title:"常用函数",content:[{item:{show:'<img src="assets/images/toolbar/func/c1.png">',val:"\\sin\\theta"}},{item:{show:'<img src="assets/images/toolbar/func/c2.png">',val:"\\sin{2x}"}},{item:{show:'<img src="assets/images/toolbar/func/c3.png">',val:"\\tan\\theta=\\frac {\\sin\\theta}{\\cos\\theta}"}}]}]}]}}}];return function(){var a=[{title:"小写",values:["alpha","beta","gamma","delta","epsilon","zeta","eta","theta","iota","kappa","lambda","mu","nu","xi","omicron","pi","rho","sigma","tau","upsilon","phi","chi","psi","omega"]},{title:"大写",values:["Alpha","Beta","Gamma","Delta","Epsilon","Zeta","Eta","Theta","Iota","Kappa","Lambda","Mu","Nu","Xi","Omicron","Pi","Rho","Sigma","Tau","Upsilon","Phi","Chi","Psi","Omega"]}],c=f[2].options.box.group[1].items;c.push({title:a[0].title,content:b({path:"assets/images/toolbar/char/greek/lower/",values:a[0].values})}),c.push({title:a[1].title,content:b({path:"assets/images/toolbar/char/greek/upper/",values:a[1].values})})}(),function(){var a=[{title:"求反关系运算符",values:["neq","ncong","nequiv","nge","ngt","nin","nle","nlt","nsim","nsubseteq","nsupseteq"]}],c=f[2].options.box.group[2].items;c.push({title:a[0].title,content:b({path:"assets/images/toolbar/char/not/",values:a[0].values})})}(),f}),a("ui/toolbar/toolbar",["kity","ui/ui-impl/ui","ui/ui-impl/drapdown-box","ui/ui-impl/delimiter","ui/ui-impl/area","ui/ui-impl/ui-utils","jquery","ui/ui-impl/def/ele-type"],function(a){function b(a,b,f){switch(a){case i.DRAPDOWN_BOX:return c(b,f);case i.DELIMITER:return d(b);case i.AREA:return e(b,f)}}function c(a,b){return new g.DrapdownBox(a,b)}function d(a){return new g.Delimiter(a)}function e(a,b){return new g.Area(a,b)}var f=a("kity"),g=a("ui/ui-impl/ui"),h=a("ui/ui-impl/ui-utils"),i=a("ui/ui-impl/def/ele-type"),j=f.createClass("Tollbar",{constructor:function(a,b,c){this.kfEditor=b,this.uiComponent=a,this.elementList=c,this.elements=[],this.initToolbarElements(),this.initServices(),this.initEvent()},initServices:function(){this.kfEditor.registerService("ui.toolbar.disable",this,{disableToolbar:this.disableToolbar}),this.kfEditor.registerService("ui.toolbar.enable",this,{enableToolbar:this.enableToolbar}),this.kfEditor.registerService("ui.toolbar.close",this,{closeToolbar:this.closeToolbar})},initEvent:function(){var a=this;h.on(this.uiComponent.toolbarContainer,"mousedown",function(a){a.preventDefault()}),h.on(this.kfEditor.getContainer(),"mousedown",function(){a.notify("closeAll")}),h.subscribe("data.select",function(b){a.insertSource(b)})},insertSource:function(a){this.kfEditor.requestService("control.insert.string",a)},disableToolbar:function(){f.Utils.each(this.elements,function(a){a.disable&&a.disable()})},enableToolbar:function(){f.Utils.each(this.elements,function(a){a.enable&&a.enable()})},getContainer:function(){return this.kfEditor.requestService("ui.get.canvas.container")},closeToolbar:function(){this.closeElement()},notify:function(a){switch(a){case"closeAll":case"closeOther":return void this.closeElement(arguments[1])}},closeElement:function(a){f.Utils.each(this.elements,function(b){b!=a&&b.hide&&b.hide()})},initToolbarElements:function(){var a=this.elements,c=this.uiComponent.toolbarContainer.ownerDocument,d=this;f.Utils.each(this.elementList,function(e){var f=b(e.type,c,e.options);a.push(f),d.appendElement(f)})},appendElement:function(a){a.setToolbar(this),a.attachTo(this.uiComponent.toolbarContainer)}});return j}),a("ui/ui-impl/area",["kity","ui/ui-impl/ui-utils","jquery","ui/ui-impl/box","ui/ui-impl/def/box-type","ui/ui-impl/def/item-type","ui/ui-impl/button","ui/ui-impl/list"],function(a){var b=a("kity"),c="kf-editor-ui-",d=a("ui/ui-impl/ui-utils"),e=a("ui/ui-impl/box"),f=b.createClass("Area",{constructor:function(a,b){this.options=b,this.doc=a,this.toolbar=null,this.disabled=!0,this.element=this.createArea(),this.container=this.createContainer(),this.button=this.createButton(),this.mountPoint=this.createMountPoint(),this.boxObject=this.createBox(),this.mergeElement(),this.mount(),this.setListener(),this.initEvent(),this.updateContent()},initEvent:function(){var a=this;d.on(this.button,"mousedown",function(b){b.preventDefault(),b.stopPropagation(),1!==b.which||a.disabled||(a.showMount(),a.toolbar.notify("closeOther",a))}),d.delegate(this.container,".kf-editor-ui-area-item","mousedown",function(b){b.preventDefault(),1!==b.which||a.disabled||d.publish("data.select",this.getAttribute("data-value"))}),this.boxObject.initEvent()},disable:function(){this.disabled=!0,this.boxObject.disable(),this.element.classList.remove(c+"enabled")},enable:function(){this.disabled=!1,this.boxObject.enable(),this.element.classList.add(c+"enabled")},setListener:function(){var a=this;this.boxObject.setSelectHandler(function(b){d.publish("data.select",b),a.hide()}),this.boxObject.setChangeHandler(function(){a.updateContent()})},createArea:function(){var a=d.ele(this.doc,"div",{className:c+"area"});return"width"in this.options&&(a.style.width=this.options.width+"px"),a},updateContent:function(){var a=this.boxObject.getOverlapContent(),d=[];this.container.innerHTML="",b.Utils.each(a,function(a){var e=a.content;b.Utils.each(e,function(a){a=a.item,d.push('<div class="'+c+'area-item" data-value="'+a.val+'"><div class="'+c+'area-item-content">'+a.show+"</div></div>")})}),this.container.innerHTML=d.join("")},mount:function(){this.boxObject.mountTo(this.mountPoint)},showMount:function(){this.mountPoint.style.display="block"},hideMount:function(){this.mountPoint.style.display="none"},hide:function(){this.hideMount(),this.boxObject.hide()},createButton:function(){return d.ele(this.doc,"div",{className:c+"area-button",content:"▼"})},createMountPoint:function(){return d.ele(this.doc,"div",{className:c+"area-mount"})},createBox:function(){return new e(this.doc,this.options.box)},createContainer:function(){var a=d.ele(this.doc,"div",{className:c+"area-container"});return a},mergeElement:function(){this.element.appendChild(this.container),this.element.appendChild(this.button),this.element.appendChild(this.mountPoint)},setToolbar:function(a){this.toolbar=a,this.boxObject.setToolbar(a)},attachTo:function(a){a.appendChild(this.element)}});return f}),a("ui/ui-impl/box",["kity","ui/ui-impl/ui-utils","jquery","ui/ui-impl/def/box-type","ui/ui-impl/def/item-type","ui/ui-impl/button","ui/ui-impl/list"],function(a){function b(a,b,c){var d=[];return f.Utils.each(b,function(b){d.push(new n(c,a,b))}),d}function c(a){return h.ele(a,"div",{className:g+"overlap-container"})}function d(a){return new k(a,{sign:!1,className:"overlap-button",label:""})}function e(a,b){return new l(a,b)}var f=a("kity"),g="kf-editor-ui-",h=a("ui/ui-impl/ui-utils"),i=a("ui/ui-impl/def/box-type"),j=a("ui/ui-impl/def/item-type"),k=a("ui/ui-impl/button"),l=a("ui/ui-impl/list"),m=f.createClass("Box",{constructor:function(a,b){this.options=b,this.toolbar=null,this.options.type=this.options.type||i.DETACHED,this.doc=a,this.overlapButtonObject=null,this.overlapIndex=-1,this.element=this.createBox(),this.groupContainer=this.createGroupContainer(),this.itemGroups=this.createItemGroup(),this.mergeElement()},createBox:function(){var a=h.ele(this.doc,"div",{className:g+"box"});return"width"in this.options&&(a.style.width=this.options.width+"px"),a},setToolbar:function(a){this.toolbar=a,this.overlapButtonObject&&this.overlapButtonObject.setToolbar(a)},updateSize:function(){var a=h.getRectBox(this.toolbar.getContainer()),b=h.getRectBox(this.element);b.bottom<=a.bottom||(this.element.style.height=b.height-(b.bottom-a.bottom+20)+"px")},initEvent:function(){var a="."+g+"box-item",b=this;h.delegate(this.groupContainer,a,"mousedown",function(a){a.preventDefault(),1===a.which&&b.onselectHandler&&b.onselectHandler(this.getAttribute("data-value"))}),h.on(this.element,"mousedown",function(a){a.stopPropagation(),a.preventDefault()}),h.on(this.element,"mousewheel",function(a){a.stopPropagation()})},getNode:function(){return this.element},setSelectHandler:function(a){this.onselectHandler=a},setChangeHandler:function(a){this.onchangeHandler=a},onchangeHandler:function(){},createGroupContainer:function(){return h.ele(this.doc,"div",{className:g+"box-container"})},getPositionInfo:function(){return h.getRectBox(this.element)},createItemGroup:function(){var a=this.createGroup();switch(this.options.type){case i.DETACHED:return a.items[0];case i.OVERLAP:return this.createOverlapGroup(a)}return null},enable:function(){this.overlapButtonObject&&this.overlapButtonObject.enable()},disable:function(){this.overlapButtonObject&&this.overlapButtonObject.disable()},hide:function(){this.overlapButtonObject&&this.overlapButtonObject.hideMount()},getOverlapContent:function(){return this.options.type!==i.OVERLAP?null:this.options.group[this.overlapIndex].items},createOverlapGroup:function(a){var b=a.title,i=this,j=c(this.doc),k=d(this.doc),l=e(this.doc,{width:150,items:b}),m=h.ele(this.doc,"div",{className:g+"wrap-group"});return this.overlapButtonObject=k,k.mount(l),k.initEvent(),l.initEvent(),f.Utils.each(a.items,function(b,c){var d=m.cloneNode(!1);f.Utils.each(b,function(a){d.appendChild(a)}),a.items[c]=d}),l.setSelectHandler(function(c,d){i.overlapIndex=c,k.setLabel(b[c]+" ▼"),k.hideMount(),a.items[d].style.display="none",a.items[c].style.display="block",i.onchangeHandler(c)}),j.appendChild(k.getNode()),f.Utils.each(a.items,function(a,b){b>0&&(a.style.display="none"),j.appendChild(a)}),l.select(0),[j]},getGroupList:function(){var a=[];return f.Utils.each(this.options.group,function(b){a.push(b.title)}),{width:150,items:a}},createGroup:function(){var a=this.doc,c=[],d={title:[],items:[]},e=null,k=null,l=i.DETACHED===this.options.type?j.BIG:j.SMALL,m=null;return e=h.ele(this.doc,"div",{className:g+"box-group"}),m=e.cloneNode(!1),m.className=g+"box-group-item-container",f.Utils.each(this.options.group,function(i){d.title.push(i.title||""),c=[],f.Utils.each(i.items,function(d){e=e.cloneNode(!1),m=m.cloneNode(!1),k=h.ele(a,"div",{className:g+"box-group-title",content:d.title}),e.appendChild(k),e.appendChild(m),f.Utils.each(b(a,d.content,l),function(a){a.appendTo(m)}),c.push(e)}),d.items.push(c)}),d},mergeElement:function(){var a=this.groupContainer;this.element.appendChild(a),f.Utils.each(this.itemGroups,function(b){a.appendChild(b)})},mountTo:function(a){a.appendChild(this.element)},appendTo:function(a){a.appendChild(this.element)}}),n=f.createClass("BoxItem",{constructor:function(a,b,c){this.type=a,this.doc=b,this.options=c,this.element=this.createItem(),this.labelNode=this.createLabel(),this.contentNode=this.createContent(),this.mergeElement()},getNode:function(){return this.element},createItem:function(){var a=h.ele(this.doc,"div",{className:g+"box-item"});return a},createLabel:function(){var a=null;if("label"in this.options)return a=h.ele(this.doc,"div",{className:g+"box-item-label",content:this.options.label})},getContent:function(){},createContent:function(){switch(this.type){case j.BIG:return this.createBigContent();case j.SMALL:return this.createSmallContent()}},createBigContent:function(){var a=this.doc,b=h.ele(a,"div",{className:g+"box-item-content"}),c=g+"box-item-val",d=this.options.item,e=null;return"string"==typeof d&&(d={show:d,val:d}),e=h.ele(a,"div",{className:c}),e.innerHTML=d.show,this.element.setAttribute("data-value",d.val),b.appendChild(e),b},createSmallContent:function(){var a=this.doc,b=h.ele(a,"div",{className:g+"box-item-content"}),c=g+"box-item-val",d=this.options.item,e=null;return"string"==typeof d&&(d={show:d,val:d}),e=h.ele(a,"div",{className:c}),e.innerHTML=d.show,this.element.setAttribute("data-value",d.val),b.appendChild(e),b},mergeElement:function(){this.labelNode&&this.element.appendChild(this.labelNode),this.element.appendChild(this.contentNode)},appendTo:function(a){a.appendChild(this.element)}});return m}),a("ui/ui-impl/button",["kity","ui/ui-impl/ui-utils","jquery"],function(a){var b=a("kity"),c="kf-editor-ui-",d=a("ui/ui-impl/ui-utils"),e=b.createClass("Button",{constructor:function(a,b){this.options=b,this.eventState=!1,this.toolbar=null,this.displayState=!1,this.doc=a,this.element=this.createButton(),this.disabled=!0,this.mountElement=null,this.icon=this.createIcon(),this.label=this.createLabel(),this.sign=this.createSign(),this.mountPoint=this.createMountPoint(),this.mergeElement()},initEvent:function(){var a=this;this.eventState||(this.eventState=!0,d.on(this.element,"mousedown",function(b){b.preventDefault(),b.stopPropagation(),1===b.which&&(a.disabled||(a.toggleSelect(),a.toggleMountElement()))}))},setToolbar:function(a){this.toolbar=a},toggleMountElement:function(){this.displayState?this.hideMount():this.showMount()},setLabel:function(a){this.label.innerHTML=a},toggleSelect:function(){this.element.classList.toggle(c+"button-in")},unselect:function(){this.element.classList.remove(c+"button-in")},select:function(){this.element.classList.add(c+"button-in")},show:function(){this.select(),this.showMount()},hide:function(){this.unselect(),this.hideMount()},showMount:function(){this.displayState=!0,this.mountPoint.style.display="block";var a=this.toolbar.getContainer(),b=null,c=d.getRectBox(a),e=this.mountElement.getPositionInfo();e.right>c.right&&(b=d.getRectBox(this.element),this.mountPoint.style.left=b.right-e.right-1+"px"),this.mountElement.updateSize&&this.mountElement.updateSize()},hideMount:function(){this.displayState=!1,this.mountPoint.style.display="none"},getNode:function(){return this.element},mount:function(a){this.mountElement=a,a.mountTo(this.mountPoint)},createButton:function(){var a=d.ele(this.doc,"div",{className:c+"button"});return this.options.className&&(a.className+=" "+c+this.options.className),a},createIcon:function(){if(!this.options.icon)return null;var a=d.ele(this.doc,"div",{className:c+"button-icon"});return a.style.backgroundImage="url("+this.options.icon+")",a},createLabel:function(){var a=d.ele(this.doc,"div",{className:c+"button-label",content:this.options.label});return a},createSign:function(){return this.options.sign===!1?null:d.ele(this.doc,"div",{className:c+"button-sign"})},createMountPoint:function(){return d.ele(this.doc,"div",{className:c+"button-mount-point"})},disable:function(){this.disabled=!0,this.element.classList.remove(c+"enabled")},enable:function(){this.disabled=!1,this.element.classList.add(c+"enabled")},mergeElement:function(){this.icon&&this.element.appendChild(this.icon),this.element.appendChild(this.label),this.sign&&this.element.appendChild(this.sign),this.element.appendChild(this.mountPoint)}});return e}),a("ui/ui-impl/def/box-type",[],function(){return{DETACHED:1,OVERLAP:2}}),a("ui/ui-impl/def/ele-type",[],function(){return{DRAPDOWN_BOX:1,AREA:2,DELIMITER:3}}),a("ui/ui-impl/def/item-type",[],function(){return{BIG:1,SMALL:2}}),a("ui/ui-impl/delimiter",["kity","ui/ui-impl/ui-utils","jquery"],function(a){var b=a("kity"),c="kf-editor-ui-",d=a("ui/ui-impl/ui-utils"),e=b.createClass("Delimiter",{constructor:function(a){this.doc=a,this.element=this.createDilimiter()},setToolbar:function(){},createDilimiter:function(){var a=d.ele(this.doc,"div",{className:c+"delimiter"});return a.appendChild(d.ele(this.doc,"div",{className:c+"delimiter-line"})),a},attachTo:function(a){a.appendChild(this.element)}});return e}),a("ui/ui-impl/drapdown-box",["kity","ui/ui-impl/ui-utils","jquery","ui/ui-impl/button","ui/ui-impl/box","ui/ui-impl/def/box-type","ui/ui-impl/def/item-type","ui/ui-impl/list"],function(a){var b=a("kity"),c=a("ui/ui-impl/ui-utils"),d=a("ui/ui-impl/button"),e=a("ui/ui-impl/box"),f=b.createClass("DrapdownBox",{constructor:function(a,b){this.options=b,this.toolbar=null,this.doc=a,this.buttonElement=this.createButton(),this.element=this.buttonElement.getNode(),this.boxElement=this.createBox(),this.buttonElement.mount(this.boxElement),this.initEvent()},initEvent:function(){var a=this;c.on(this.element,"mousedown",function(b){b.preventDefault(),b.stopPropagation(),a.toolbar.notify("closeOther",a)}),this.buttonElement.initEvent(),this.boxElement.initEvent(),this.boxElement.setSelectHandler(function(b){c.publish("data.select",b),a.buttonElement.hide()})},disable:function(){this.buttonElement.disable()},enable:function(){this.buttonElement.enable()},setToolbar:function(a){this.toolbar=a,this.buttonElement.setToolbar(a),this.boxElement.setToolbar(a)},createButton:function(){return new d(this.doc,this.options.button)},show:function(){this.buttonElement.show()},hide:function(){this.buttonElement.hide()},createBox:function(){return new e(this.doc,this.options.box)},attachTo:function(a){a.appendChild(this.element)
}});return f}),a("ui/ui-impl/list",["kity","ui/ui-impl/ui-utils","jquery"],function(a){var b=a("kity"),c="kf-editor-ui-",d=a("ui/ui-impl/ui-utils"),e=b.createClass("List",{constructor:function(a,b){this.options=b,this.doc=a,this.onselectHandler=null,this.currentSelect=-1,this.element=this.createBox(),this.itemGroups=this.createItems(),this.mergeElement()},onselectHandler:function(){},setSelectHandler:function(a){this.onselectHandler=a},createBox:function(){var a=d.ele(this.doc,"div",{className:c+"list"}),b=d.ele(this.doc,"div",{className:c+"list-bg"});return"width"in this.options&&(a.style.width=this.options.width+"px"),a.appendChild(b),a},select:function(a){var b=this.currentSelect;-1===b&&(b=a),this.unselect(b),this.currentSelect=a,this.itemGroups.items[a].firstChild.style.visibility="visible",this.onselectHandler(a,b)},unselect:function(a){this.itemGroups.items[a].firstChild.style.visibility="hidden"},initEvent:function(){var a="."+c+"list-item",b=this;d.delegate(this.itemGroups.container,a,"mousedown",function(a){a.preventDefault(),1===a.which&&b.select(this.getAttribute("data-index"))}),d.on(this.element,"mousedown",function(a){a.stopPropagation(),a.preventDefault()})},getPositionInfo:function(){return d.getRectBox(this.element)},createItems:function(){var a=this.doc,e=null,f=null,g=null,h=[],i=null;return e=d.ele(this.doc,"div",{className:c+"list-item"}),i=e.cloneNode(!1),i.className=c+"list-item-container",b.Utils.each(this.options.items,function(b,j){f=e.cloneNode(!1),g=e.cloneNode(!1),g.className=c+"list-item-icon",g.innerHTML='<img src="assets/images/toolbar/button/tick.png">',f.appendChild(g),f.appendChild(d.ele(a,"text",b)),f.setAttribute("data-index",j),h.push(f),i.appendChild(f)}),{container:i,items:h}},mergeElement:function(){this.element.appendChild(this.itemGroups.container)},mountTo:function(a){a.appendChild(this.element)}});return e}),a("ui/ui-impl/ui-utils",["jquery","kity"],function(a){var b=a("jquery"),c=a("kity"),d={};return{ele:function(a,b,c){var d=null;return"text"===b?a.createTextNode(c):(d=a.createElement(b),c.className&&(d.className=c.className),c.content&&(d.innerHTML=c.content),d)},getRectBox:function(a){return a.getBoundingClientRect()},on:function(a,c,d){return b(a).on(c,d),this},delegate:function(a,c,d,e){return b(a).delegate(c,d,e),this},publish:function(a,b){var e=d[a];e&&(b=[].slice.call(arguments,1),c.Utils.each(e,function(a){a.apply(null,b)}))},subscribe:function(a,b){d[a]||(d[a]=[]),d[a].push(b)}}}),a("ui/ui-impl/ui",["ui/ui-impl/drapdown-box","kity","ui/ui-impl/ui-utils","ui/ui-impl/button","ui/ui-impl/box","ui/ui-impl/delimiter","ui/ui-impl/area"],function(a){return{DrapdownBox:a("ui/ui-impl/drapdown-box"),Delimiter:a("ui/ui-impl/delimiter"),Area:a("ui/ui-impl/area")}}),a("ui/ui",["kity","base/utils","base/common","base/event/event","ui/toolbar/toolbar","ui/ui-impl/ui","ui/ui-impl/ui-utils","ui/ui-impl/def/ele-type","ui/control/zoom","ui/toolbar-ele-list","ui/ui-impl/def/box-type"],function(a){function b(a){var b=a.createElement("div");return b.className="kf-editor-toolbar",b}function c(a){var b=a.createElement("div");return b.className="kf-editor-edit-area",b.style.width="80%",b.style.height="800px",b}function d(a){var b=a.createElement("div");return b.className="kf-editor-canvas-container",b}var e=a("kity"),f=a("base/utils"),g=a("ui/toolbar/toolbar"),h=a("ui/control/zoom"),i=a("ui/toolbar-ele-list"),j=e.createClass("UIComponent",{constructor:function(a){var e=null;this.container=a.getContainer(),e=this.container.ownerDocument,this.components={},this.kfEditor=a,this.resizeTimer=null,this.toolbarContainer=b(e),this.editArea=c(e),this.canvasContainer=d(e),this.updateContainerSize(this.container,this.toolbarContainer,this.editArea,this.canvasContainer),this.container.appendChild(this.toolbarContainer),this.editArea.appendChild(this.canvasContainer),this.container.appendChild(this.editArea),this.initComponents(),this.initServices(),this.initEvent(),this.initResizeEvent()},initComponents:function(){this.components.toolbar=new g(this,this.kfEditor,i),this.components.scrollZoom=new h(this,this.kfEditor,this.canvasContainer)},updateContainerSize:function(a,b,c){var d=a.getBoundingClientRect();b.style.width=d.width+"px",b.style.height="80px",c.style.marginTop="80px",c.style.width=d.width+"px",c.style.height=d.height-80+"px"},initServices:function(){this.kfEditor.registerService("ui.get.canvas.container",this,{getCanvasContainer:k.getCanvasContainer}),this.kfEditor.registerService("ui.canvas.container.event",this,{on:k.addEvent,off:k.removeEvent,trigger:k.trigger,fire:k.trigger})},initEvent:function(){f.addEvent(this.container,"mousewheel",function(a){a.preventDefault()})},initResizeEvent:function(){var a=this;this.canvasContainer.ownerDocument.defaultView.onresize=function(){window.clearTimeout(a.resizeTimer),a.resizeTimer=window.setTimeout(function(){a.kfEditor.requestService("render.relocation")},80)}}}),k={getCanvasContainer:function(){return this.canvasContainer},addEvent:function(a,b){f.addEvent(this.canvasContainer,a,b)},removeEvent:function(){},trigger:function(a){f.trigger(this.canvasContainer,a)}};return j}),function(){a("kf.start",function(a){var b=a("editor/editor");b.registerComponents("ui",a("ui/ui")),b.registerComponents("parser",a("parse/parser")),b.registerComponents("render",a("render/render")),b.registerComponents("position",a("position/position")),b.registerComponents("syntax",a("syntax/syntax")),b.registerComponents("control",a("control/controller")),kf.Editor=b});try{c("kf.start")}catch(b){}}(this)}();